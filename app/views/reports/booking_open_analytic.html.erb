<style type="text/css">
<!--
@page { size:auto; margin: 1cm }
-->
</style>

<style media="print">
 h1.medaT-report{padding: 0px 0px; margin: 0px 0px; font-size: 13px;}
 table.medaT-report tr td, table.medaT-report tr th{font-size: 9px; padding: 0px 2px}
</style>


<h1>Elenco booking aperti - Analitica</h1>

<%
#Recupero elenco movimenti in base ai parametri

formValues = JSON.parse params['formValues']

items = Booking.not_closed()
items = items.where(shipowner_id: formValues['shipowner_id']) unless formValues['shipowner_id'].blank?

group_shipowner = items.group_by { |d| d.shipowner_id }
%>


<%
 ######################################################
 #ShipOwner
 ###################################################### 
%>
<% group_shipowner.each do |so_id, so_val| %>
 <% so = Shipowner.find(so_id) %>

    <p class="bg-primary" style="padding: 10px"><%= so.name -%> (conteggio: <%= "#{so_val.count()}" -%>)</p>
 

	<%
 	######################################################
 	#NAVE / viaggio
 	###################################################### 
	%>
 	<% group_op = so_val.group_by { |d|
 		[d.ship_id, d.voyage].join('____')
 		} %>
	<% group_op.each do |op_id, op_val| %>

 		
 		<h4>Nave: <b><%= op_val[0].ship.name -%></b> - Viaggio <b><%= op_val[0].voyage -%></b></h4>

		<%
 		######################################################
 		#Tipo operazioni
 		###################################################### 
		%>
		<table class="table table-striped table-bordered table-condensed medaT-report">
		 <tr>
		  <th width=50>Tipo</th>
		  <th width=80>Booiking</th>
		  <th width=80>Data prenotazione</th>
		  <th width=80>Scadenza</th>
		  <th width=40 style="text-align: right;">Quantit&agrave;</th>
		  <th width=40 style="text-align: right;">Usciti</th>
		  <th width=100>Note / Frigo</th>
		 </tr>


		<% op_val.sort_by{|a| 		
				a.id		
			}.each do |row| %>
			
			<% row.booking_items.each do |bi| %>			
	 			<tr>
					<td><%= bi.equipment.equipment_type -%></td>	 			
					<td><%= row.num_booking -%></td>	
					<td><%= row.created_at.strftime("%d/%m/%y") -%>
					<td><%= !row.expiration.nil? ? row.expiration.strftime("%d/%m/%y") : '' -%>
					<td align=right><%= bi.quantity -%></td>
					<td align=right><%= bi.quantity_used -%></td>
					<td><%= row.notes -%>
						<% if !bi.temperature.to_s.empty? || !bi.ventilation.to_s.empty? || !bi.humidity.to_s.empty?  %>
						 <%= " Temp: #{bi.temperature.to_s}" if !bi.temperature.to_s.empty? -%>
						 <%= " Vent: #{bi.ventilation.to_s}" if !bi.ventilation.to_s.empty? -%>
						 <%= " Umid: #{bi.humidity.to_s}" if !bi.humidity.to_s.empty? -%>
						<% end %>
						
					</td>
				</tr>
			<% end %>	
		<% end %>
		</table>


	<% end %>








 
<% end %>