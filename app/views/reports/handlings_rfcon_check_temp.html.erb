<style type="text/css">
<!--
@page { size:auto; margin: 1cm }
-->
</style>

<style media="print">
 h1.medaT-report{padding: 0px 0px; margin: 0px 0px; font-size: 13px;}
 table.medaT-report tr td, table.medaT-report tr th{font-size: 9px; padding: 0px 2px}
</style>


<h1 class=medaT-report>RF: check temperature</h1>

<%
#Recupero elenco movimenti in base ai parametri

formValues = JSON.parse params['formValues']

items = HandlingItem.where('1=1')
items = items.where({handling_headers: {shipowner_id: formValues['shipowner_id']} }) unless formValues['shipowner_id'].blank?
items = items.where({handling_item_type: formValues['handling_item_type']}) unless formValues['handling_item_type'].blank?
items = items.where("operation_type = ?", 'AF')
items = items.where("datetime_op_end IS NULL")


items = items.joins(:handling_header)
group_shipowner = items.group_by { |d| d.handling_header.shipowner_id }
%>


<%
 ######################################################
 #ShipOwner
 ###################################################### 
%>
<% group_shipowner.each do |so_id, so_val| %>
 <% so = Shipowner.find(so_id) %>

    <p class="bg-primary" style="padding: 10px"><%= so.name -%></p>
 

	<%
 	######################################################
 	#Tipo operazioni
 	###################################################### 
	%>
 	<% group_op = so_val.group_by { |d| d.handling_item_type } %>
	<% group_op.each do |op_id, op_val| %>

		<%
 		######################################################
 		#Tipo operazioni
 		###################################################### 
		%>
		<table class="table table-striped table-bordered table-condensed medaT-report">
		 <tr>
		  <th width=80>Container</th>
		  <th width=40>Tipo</th>
		  <th width=70>Allacciato il</th>		  
		  <th width=80>Booking</th>
		  <th width=60>Temp</th>
		  <th width=80>Check 1</th>
		  <th width=80>Check 2</th>
		  <th width=80>Check 3</th>
		  <th width=80>Check 4</th>		  		  
		 </tr>

		<% op_val.sort_by{|a| 
		
			if formValues['seq_ord'] == 'date_tipo'
				[a.datetime_op, a.handling_header.equipment.equipment_type]
			else
				[a.handling_header.equipment.equipment_type, a.datetime_op]
			end
		
		
			}.each do |row| %>
			<% eq = Equipment.find(row.handling_header.equipment_id) %>
			
			<%
			 out_ship 		= ""
			 out_voyage		= ""
			 out_booking 	= ""
			 
			 is_import_export = row.is_import_export()			 
			 bki = row.search_booking_item			 
			 			 
			 if !row.booking.nil?
			 	out_booking = row.booking.num_booking.to_s
			 else
			 	out_booking = "#{bki.booking.num_booking.to_s}" if !bki.nil?
			 end
			  
			 if is_import_export == 'E'
			  	#Export: recuper temp da booking			 			 
				  if !bki.nil?
				   out_temp 	= "#{bki.temperature.to_s}"
				  end
			  else
			     #Import: 
			       out_temp 	= row.handling_header.temperature_imp
			 end
			 
			 
			  
			%>
			
			
						
 			<tr>
				<td><%= row.handling_header.container_number.to_s -%></td> 
				<td><%= eq.equipment_type -%></td>							
 				<td><%= row.datetime_op.strftime("%d/%m/%y %H:%M") -%></td>				
				<td><%= out_booking -%></td>
				<td><%= out_temp -%></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
			</tr>
		<% end %>
		</table>


	<% end %>








 
<% end %>